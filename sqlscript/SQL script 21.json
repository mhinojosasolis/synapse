{
	"name": "SQL script 21",
	"properties": {
		"content": {
			"query": "SET ANSI_NULLS ON\nGO\nSET QUOTED_IDENTIFIER ON\nGO\n\nCREATE PROC [DM_VitalSigns].[sp_load_ft_KPIs] AS\n----AND id_shift = 210627002  AND (Start_Hos = 0 OR End_Hos = 0)\n\nDECLARE @maxShiftId int \nSELECT @maxShiftId = MAX([id_Shift]) FROM [DM_Dispatch].[FT_KPIS_HOURS] \nPRINT @maxShiftId\n\n--TEST\n--SET @maxShiftId = 210627002\n\nDECLARE @shiftDate date\nSET @shiftDate = CAST('20'+LEFT(@maxShiftId,6) AS date)\nPRINT @shiftDate\n\nDECLARE @maxHos int \nSELECT @maxHos = MAX([Hos]) FROM [DM_Dispatch].[FT_KPIS_HOURS] WHERE id_shift = @maxShiftId\nPRINT @maxHos\n\n--TEST\n--SET @maxHos = 0\n\nDECLARE @Date datetime2\nSET @Date = DATEADD(hh, @maxHos, CAST(@shiftDate AS DATETIME2) )\nPRINT @Date\n\n--creamos la key de la fecha\nDECLARE @idTime bigint\nSET @idTime = CAST(DATEPART(yyyy,@Date) as bigint) * 100000000 +\n\t\t\t\tDATEPART(mm,@Date) * 1000000 +\n\t\t\t\tDATEPART(dd,@Date) * 10000 +\n\t\t\t\tDATEPART(hh,@Date) * 100 +\n\t\t\t\tDATEPART(n,@Date)\n\nPRINT @idTime\n\n----si ya existe el kpi para esa fecha, lo borramos\nIF EXISTS (SELECT * FROM [DM_VitalSigns].[ft_KPIs] WHERE [id_Time] =  @idTime)\nBEGIN\n\tDELETE FROM [DM_VitalSigns].[ft_KPIs] WHERE [id_Time] =  @idTime\nEND\n\nEXEC [DM_VitalSigns].[sp_load_dm_Time] @idTime\n\n;WITH cte_shift_hos AS\n(\n\n\tSELECT \n\t\t [id_Shift]\n\t\t  ,[id_Eqmt]\n\t\t  ,[id_Unit]\n\t\t  ,[Hos]\n\t\t  ,CAST([P200] AS numeric(15, 5)) AS [P200]\n\t\t  ,CAST([P100] AS numeric(15, 5)) AS [P100]\n\t\t  ,CAST([L300] AS numeric(15, 5)) AS [L300]\n\t\t  ,CAST([L200] AS numeric(15, 5)) AS [L200]\n\t\t  ,CAST([L100] AS numeric(15, 5)) AS [L100]\n\t\t  ,CAST([D300] AS numeric(15, 5)) AS [D300]\n\t\t  ,CAST([D200] AS numeric(15, 5)) AS [D200]\n\t\t  ,CAST([D100] AS numeric(15, 5)) AS [D100]\n\t\t  ,CAST([N200] AS numeric(15, 5)) AS [N200]\n\t\t  ,CAST([N100] AS numeric(15, 5)) AS [N100]\n\t\t  ,CAST([T300] AS numeric(15, 5)) AS [T300]\n\t\t  ,CAST([T200] AS numeric(15, 5)) AS [T200]\n\t\t  ,CAST([T100] AS numeric(15, 5)) AS [T100]\n\t\t  ,CAST([T000] AS numeric(15, 5)) AS [T000]\n\t\t  ,CAST([L000] AS numeric(15, 5)) AS [L000]\n\t\t  ,CAST([D000] AS numeric(15, 5)) AS [D000]\n\t\t  ,CAST([N000] AS numeric(15, 5)) AS [N000]\n\t\t  ,[UpdateDate]\n\t\t  ,[InsertDate]\n\t  FROM [DM_Dispatch].[FT_KPIS_HOURS]\n\tWHERE id_shift = @maxShiftId AND Hos = @maxHos\n\t--WHERE id_shift = 210627002 ANd Hos = 0\n), \n--cálculo DF\n--Disponibilidad Física\n--DF = T200/T100\ncte_DF AS \n(\n\tSELECT  id_Eqmt\n\t\t\t, SUM(T200) AS T200\n\t\t\t, SUM(T100) AS T100\n\t\t\t, CASE COALESCE(SUM(T100), 0) WHEN 0 THEN 0\n\t\t\t\tELSE (SUM(T200)  / SUM(T100)) * 100\n\t\t\tEND AS DF\n\tFROM cte_shift_hos\n\tGROUP BY id_Eqmt\n),\n--cálculo DO\n--Disponibilidad Operacional\n--DO= T200/(T200+D300)\ncte_DO AS \n(\n\tSELECT  id_Eqmt\n\t\t\t, SUM(T200) AS T200\n\t\t\t, SUM(D300) AS D300\n\t\t\t, CASE (COALESCE(SUM(T200), 0) + COALESCE(SUM(D300), 0)) WHEN 0 THEN 0\n\t\t\t\tELSE (SUM(T200)  / (SUM(T200)+SUM(D300))) * 100\n\t\t\tEND AS DO\n\tFROM cte_shift_hos\n\tGROUP BY id_Eqmt\n),\n/*CantD100 */\ncte_CantD100 AS (\n\tSELECT id_eqmt AS id_Eqmt, COUNT(*) AS 'CantD100'\n\tFROM [DM_Dispatch].[FT_SHIFTSTATE] f\n\t  INNER JOIN [DM_Dispatch].[DM_STATUS] s on s.id_status = f.id_status\n\t  INNER JOIN [DM_Dispatch].[DM_REASON] r on r.[id_Reason] = f.[id_reason]\n\t  INNER JOIN [DM_Dispatch].[DM_TIMECAT] t on t.[TimeCatIdx] = f.[id_TimeCat]\n\tWHERE [Status] = 'Panne'\n\tand [TimeCat] = 'Mantenimiento No Programado'\n\t--and [StartTime] between tiempo1 and tiempo2\n\t --AND id_shift = 210627002  AND (Start_Hos = 0 OR End_Hos = 0)\n\t AND id_shift = @maxShiftId  AND (Start_Hos = @maxHos OR End_Hos = @maxHos)\n\tGROUP BY id_eqmt\n),\n/*CantD300 */\ncte_CantD300 AS ( \n\tSELECT id_eqmt AS id_Eqmt, COUNT(*) AS 'CantD300'\n\tFROM [DM_Dispatch].[FT_SHIFTSTATE] f\n\t  INNER JOIN [DM_Dispatch].[DM_STATUS] s on s.id_status = f.id_status\n\t  INNER JOIN [DM_Dispatch].[DM_REASON] r on r.[id_Reason] = f.[id_reason]\n\t  INNER JOIN [DM_Dispatch].[DM_TIMECAT] t on t.[TimeCatIdx] = f.[id_TimeCat]\n\tWHERE [Status] = 'Panne'\n\tand [TimeCat] = 'Mantenimiento No Programado'\n\t--and [StartTime] between tiempo1 and tiempo2\n\tAND id_shift = @maxShiftId  AND (Start_Hos = @maxHos OR End_Hos = @maxHos)\n\t--AND id_shift = 210627002  AND (Start_Hos = 0 OR End_Hos = 0)\n\tGROUP BY id_eqmt\n),\n/*\nTMEF\nTiempo Medio Entre Fallas\nTMEF = T300/Cant .(D100+D300)\n*/\ncte_TMEF AS \n(\n\tSELECT  c.id_Eqmt\n\t\t\t, SUM(T300) AS T300\n\t\t\t, SUM(CantD100) AS CantD100\n\t\t\t, SUM(CantD300) AS CantD300\n\t\t\t, CASE ( COALESCE(SUM(CantD100), 0) + COALESCE(SUM(CantD300), 0)) WHEN 0 THEN 0\n\t\t\t\tELSE SUM(T300)  / (SUM(CantD100)+SUM(CantD300))\n\t\t\tEND AS TMEF\n\tFROM cte_shift_hos c INNER JOIN cte_CantD100 c1 ON c.id_Eqmt = c1.id_Eqmt\n\tINNER JOIN cte_CantD300 c3 ON c.id_Eqmt = c3.id_Eqmt\n\tGROUP BY c.id_Eqmt\n),\n/*\nTMPRFM\nTiempo Medio para Reparar Fallas de Mantención\nTMPRFM = D100 / Cant.(D100)\n*/\ncte_TMPRFM AS \n(\n\tSELECT  c.id_Eqmt\n\t\t\t, SUM(D100) AS D100\n\t\t\t, SUM(CantD100) AS CantD100\n\t\t\t, CASE COALESCE(SUM(CantD100), 0) WHEN 0 THEN 0\n\t\t\t\tELSE (SUM(D100) / SUM(CantD100))\n\t\t\tEND AS TMPRFM\n\tFROM cte_shift_hos c INNER JOIN cte_CantD100 c1 ON c.id_Eqmt = c1.id_Eqmt\n\tGROUP BY c.id_Eqmt\n),\n/*\nTMPRF\nTiempo Medio para Reparar Fallas\nTMPRF = D100+D300/Cant.(D100+D300)\n*/\ncte_TMPRF AS \n(\n\tSELECT  c.id_Eqmt\n\t\t\t, SUM(D100) AS D100\n\t\t\t, SUM(D300) AS D300\n\t\t\t, SUM(CantD100) AS CantD100\n\t\t\t, SUM(CantD300) AS CantD300\n\t\t\t, CASE ( COALESCE(SUM(CantD100), 0) + COALESCE(SUM(CantD300), 0)) WHEN 0 THEN 0\n\t\t\t\tELSE (SUM(D100) + SUM(D300))  / (SUM(CantD100)+SUM(CantD300))\n\t\t\tEND AS TMPRF\n\tFROM cte_shift_hos c INNER JOIN cte_CantD100 c1 ON c.id_Eqmt = c1.id_Eqmt\n\tINNER JOIN cte_CantD300 c3 ON c.id_Eqmt = c3.id_Eqmt\n\tGROUP BY c.id_Eqmt\n),\n/*\nMNP\nMNP = Cant.(D100)\n*/\ncte_MNP AS \n(\n\tSELECT  c.id_Eqmt\n\t\t\t, SUM(CantD100) AS MNP\n\tFROM cte_shift_hos c INNER JOIN cte_CantD100 c1 ON c.id_Eqmt = c1.id_Eqmt\n\tGROUP BY c.id_Eqmt\n),\n/*\nMPvsMNP\nMPvsMNP  = D200/D100\n*/\ncte_MPvsMNP AS \n(\n\tSELECT  id_Eqmt\n\t\t\t, SUM(D200) AS D200\n\t\t\t, SUM(D100) AS D100\n\t\t\t, CASE COALESCE(SUM(D100), 0) WHEN 0 THEN 0\n\t\t\t\tELSE SUM(D200)  / SUM(D100)\n\t\t\tEND AS MPvsMNP\n\tFROM cte_shift_hos\n\tGROUP BY id_Eqmt\n),\n/*\nCant_Equipos_Flota (calculo auxiliar)\n*/\ncte_Cant_Equipos_Flota AS \n(\n\tSELECT  a.Type\n\t\t\t, count(*) AS Cant_Equipos_Flota\n\tFROM cte_shift_hos c \n\tLEFT JOIN  [DM_VitalSigns].[dm_Asset] a ON a.[Asset] = c.[id_Eqmt]\n\tGROUP BY a.Type\n),\n/*\nCant_Equipos_Area (calculo auxiliar)\n*/\ncte_Cant_Equipos_Area AS \n(\n\tSELECT  a.Productivity_Area\n\t\t\t, count(*) AS Cant_Equipos_Area\n\tFROM cte_shift_hos c \n\tLEFT JOIN  [DM_VitalSigns].[MappingProdArea] a ON a.eqmt = c.[id_Eqmt]\n\tGROUP BY a.Productivity_Area\n),\n/*\nTMEF_OPERACION  = SUMA(TMEF por Equipo)/Cant.(Equipos) \n (agrupados por Flota)\n*/\ncte_TMEF_Operacion AS \n(\n\tSELECT  c.id_Eqmt\n\t\t\t,a.Type\n\t\t\t, SUM(TMEF) AS TMEF_Equipo\n\t\t\t, SUM(q.Cant_Equipos_Flota) AS Cant_Equipos_Flota\n\t\t\t, CASE COALESCE(SUM(q.Cant_Equipos_Flota), 0) WHEN 0 THEN 0\n\t\t\t\tELSE SUM(TMEF)  / SUM(q.Cant_Equipos_Flota)\n\t\t\tEND AS TMEF_Operacion\n\tFROM cte_TMEF c\n\tLEFT JOIN  [DM_VitalSigns].[dm_Asset] a ON a.[Asset] = c.[id_Eqmt]\n\tLEFT JOIN cte_Cant_Equipos_Flota q ON q.Type = a.Type\n\tGROUP BY c.id_Eqmt,a.Type\n),\n/*\nTMEF_Area  = SUMA(TMEF por Equipo)/Cant.(Equipos) \n (agrupados por Área Productiva)\n */\n cte_TMEF_Area AS \n(\n\tSELECT  c.id_Eqmt\n\t\t\t,a.Productivity_Area\n\t\t\t, SUM(TMEF) AS TMEF_Equipo\n\t\t\t, SUM(q.Cant_Equipos_Area) AS Cant_Equipos_Area\n\t\t\t, CASE COALESCE(SUM(q.Cant_Equipos_Area), 0) WHEN 0 THEN 0\n\t\t\t\tELSE SUM(TMEF)  / SUM(q.Cant_Equipos_Area)\n\t\t\tEND AS TMEF_Area\n\tFROM cte_TMEF c\n\tLEFT JOIN  [DM_VitalSigns].[MappingProdArea] a ON a.eqmt = c.[id_Eqmt]\n\tLEFT JOIN cte_Cant_Equipos_Area q ON q.Productivity_Area = a.Productivity_Area\n\tGROUP BY c.id_Eqmt,a.Productivity_Area\n)\n\n--SELECT * FROM cte_shift_hos\n--SELECT * FROM cte_DO\n--SELECT * FROM cte_CantD300\n--SELECT * FROM cte_TMEF\n--SELECT * FROM cte_TMPRFM\n--SELECT * FROM cte_TMPRF\n--SELECT * FROM cte_MNP\n--SELECT * FROM cte_MPvsMNP\n--SELECT * FROM cte_Cant_Equipos_Flota\n--SELECT * FROM cte_Cant_Equipos_Area\n--SELECT * FROM cte_TMEF_Operacion\n--SELECT * FROM cte_TMEF_Area\n\n\nINSERT INTO [DM_VitalSigns].[ft_KPIs]\n\t\t\t([id_Organization]\n\t\t\t,[id_Area]\n\t\t\t,[id_MacroProcess]\n\t\t\t,[id_Time]\n\t\t\t,[id_Asset]\n\t\t\t,[id_Sources]\n\t\t\t,[DF]\n\t\t\t,[DO]\n\t\t\t,[TMEF]\n\t\t\t,[TMEF_Area]\n\t\t\t,[TMEF_Operacion]\n\t\t\t,[TMPRFM]\n\t\t\t,[TMPRF]\n\t\t\t,[MNP]\n\t\t\t,[MPvsMNP]\n\t\t\t,[InsertDate])\n\nSELECT \n\t\t1 AS id_Organization\n\t\t, 1 AS id_Area\n\t\t, 2 AS id_Macroprocess\n\t\t, @idTime AS id_Time\n\t\t, [id_Asset]\n\t\t, 2 AS id_Source\n\t\t,[DF]\n\t\t,[DO]\n\t\t,[TMEF]\n\t\t,[TMEF_Area]\n\t\t,[TMEF_Operacion]\n\t\t,[TMPRFM]\n\t\t,[TMPRF]\n\t\t,[MNP]\n\t\t,[MPvsMNP]\n\t\t,getutcdate()\n\t\t--, *\nFROM cte_DF df INNER JOIN cte_DO do ON df.id_Eqmt = do.id_Eqmt\nINNER JOIN cte_TMEF TMEF ON df.id_Eqmt = TMEF.id_Eqmt\nINNER JOIN cte_TMPRFM TMPRFM ON df.id_Eqmt = TMPRFM.id_Eqmt\nINNER JOIN cte_TMPRF TMPRF ON df.id_Eqmt = TMPRF.id_Eqmt\nINNER JOIN cte_MNP MNP ON df.id_Eqmt = MNP.id_Eqmt\nINNER JOIN cte_MPvsMNP MPvsMNP ON df.id_Eqmt = MPvsMNP.id_Eqmt\nINNER JOIN cte_TMEF_Operacion TMEF_Op  ON df.id_Eqmt = TMEF_Op.id_Eqmt\nINNER JOIN cte_TMEF_Area TMEF_Ar  ON df.id_Eqmt = TMEF_Ar.id_Eqmt\nLEFT JOIN  [DM_VitalSigns].[dm_Asset] a ON a.[Asset] = df.[id_Eqmt]\nGO",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "devmycpool1",
				"poolName": "devmycpool1"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}